class InteractivePortfolio{constructor(){this.config=null,this.isLoading=!1,this.currentLanguage="tr";try{this.mockMode="true"===new URLSearchParams(window.location.search).get("mock")}catch(e){this.mockMode=!1}this.init()}sleep(e){return new Promise(t=>setTimeout(t,e))}async init(){try{await this.loadBootstrap(),this.setupEventListeners(),this.updateWelcomeTime(),this.updateComposerPadding()}catch(e){console.error("Initialization error:",e),this.showError("Uygulama başlatılırken bir hata oluştu. Lütfen sayfayı yenileyin.")}}async loadBootstrap(){try{const e=await fetch("/api/bootstrap");if(!e.ok)throw new Error(`HTTP ${e.status}`);this.config=await e.json(),this.updateUI()}catch(e){throw console.error("Bootstrap loading error:",e),e}}updateUI(){if(this.config){if(this.updateElement("profileName",this.config.profile.name),this.updateElement("profileTitle",this.config.profile.title),this.config.profile.profile_image){const e=document.getElementById("profileImage"),t=document.getElementById("avatarPlaceholder");e&&t&&(e.src=this.config.profile.profile_image,e.style.display="block",t.style.display="none")}this.updateSuggestedCommands(this.config.prompts),this.updateTheme(this.config.theme)}}updateElement(e,t){const n=document.getElementById(e);n&&(n.textContent=t)}updateSuggestedCommands(e){const t=document.getElementById("suggestedCommands").querySelector(".commands-scroll");t.innerHTML="",e.forEach((e,n)=>{const o=document.createElement("button");o.className="command-chip",o.textContent=e,o.setAttribute("role","button"),o.setAttribute("aria-label",`Hazır komut: ${e}`),o.setAttribute("tabindex","0"),o.addEventListener("click",()=>this.selectCommand(e)),o.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),this.selectCommand(e))}),t.appendChild(o)})}updateTheme(e){if(e.colors){const t=document.documentElement;Object.entries(e.colors).forEach(([e,n])=>{t.style.setProperty(`--${e}`,n)})}}selectCommand(e){const t=document.getElementById("messageInput");t.value=e,t.focus(),this.updateSendButton(),this.announceToScreenReader(`Seçilen komut: ${e}`)}announceToScreenReader(e){const t=document.createElement("div");t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.className="sr-only",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t)},1e3)}setupEventListeners(){const e=document.getElementById("messageInput");e.addEventListener("input",()=>{this.updateSendButton(),this.updateComposerPadding()}),e.addEventListener("keydown",e=>this.handleKeyDown(e));const t=document.getElementById("sendButton");t.addEventListener("click",()=>this.sendMessage()),t.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),this.sendMessage())}),document.addEventListener("keydown",e=>this.handleGlobalKeyDown(e));let n=null;window.addEventListener("resize",()=>{n&&clearTimeout(n),n=setTimeout(()=>this.updateComposerPadding(),150)});document.getElementById("leadForm").addEventListener("submit",e=>this.handleLeadSubmit(e));const o=document.getElementById("leadModal"),s=document.getElementById("modalClose"),a=document.getElementById("privacyModal"),i=document.getElementById("privacyModalClose"),d=document.getElementById("privacyLink");s.addEventListener("click",()=>this.closeModal(o)),i.addEventListener("click",()=>this.closeModal(a)),d.addEventListener("click",e=>{e.preventDefault(),this.openModal(a)}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(o.classList.contains("active")&&this.closeModal(o),a.classList.contains("active")&&this.closeModal(a))}),[o,a].forEach(e=>{e.addEventListener("click",t=>{t.target===e&&this.closeModal(e)})})}handleGlobalKeyDown(e){if((e.ctrlKey||e.metaKey)&&"k"===e.key){e.preventDefault();document.getElementById("messageInput").focus(),this.announceToScreenReader("Mesaj yazma alanına odaklandı")}}updateSendButton(){const e=document.getElementById("messageInput"),t=document.getElementById("sendButton"),n=e.value.trim().length>0;t.disabled=!n||this.isLoading}handleKeyDown(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),!this.isLoading&&e.target.value.trim()&&this.sendMessage())}async sendMessage(){const e=document.getElementById("messageInput"),t=e.value.trim(),n=document.getElementById("loading-indicator");if(t&&!this.isLoading){this.isLoading=!0,this.updateSendButton(),n.style.display="flex",this.announceToScreenReader("Yanıt bekleniyor..."),this.addMessage("user",t),e.value="",autoResizeTextarea();try{if(this.mockMode){const e=this.showTypingPlaceholder();await this.sleep(600+Math.floor(800*Math.random())),this.removeTypingPlaceholder(e);const t={text:"Bu, yerel mock cevabıdır. Gerçek OpenAI çağrısı yapılmadı.",leadRequested:!1};return this.addMessage("assistant",t.text),void(t.leadRequested&&this.openLeadModal(t.leadData||{}))}const e=await fetch("/api/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t,lang:this.currentLanguage})});if(!e.ok){let t=null;try{t=await e.json()}catch(e){console.error("Failed to parse error body",e)}const n=t&&(t.error||t.message)||`Sunucu hatası: ${e.status}`;return console.error("Server responded with error:",e.status,n,t),void this.addMessage("assistant",`Üzgünüm, bir hata oluştu: ${n}`,{isError:!0})}const n=await e.json();this.addMessage("assistant",n.text),n.leadRequested&&this.openLeadModal(n.leadData||{})}catch(e){console.error("Send message error:",e),this.addMessage("assistant","Üzgünüm, bir hata oluştu. Lütfen tekrar deneyin.",{isError:!0})}finally{this.isLoading=!1,this.updateSendButton(),n.style.display="none"}}}addMessage(e,t,n={}){const o=document.getElementById("message-list"),s=document.createElement("div");s.className=`message ${e}`,n.isError&&s.classList.add("error");const a=document.createElement("div");if(a.className="message-content",n.raw)a.innerHTML=t;else{const n=this.escapeHtml(String(t));if(n.length>300&&"assistant"===e){const e=n.substring(0,300)+"...",t=n,o=document.createElement("span");o.className="short-content",o.textContent=e;const s=document.createElement("span");s.className="full-content",s.style.display="none",s.textContent=t;const i=document.createElement("button");i.className="expand-btn",i.textContent="Devamını göster",i.onclick=function(){o.style.display="none",s.style.display="inline",this.style.display="none"},a.appendChild(o),a.appendChild(s),a.appendChild(i)}else a.innerHTML=n.replace(/\n/g,"<br>")}const i=document.createElement("div");return i.className="message-time",i.textContent=this.formatTime(new Date),s.appendChild(a),s.appendChild(i),o.appendChild(s),this.autoScrollToBottom(o),s}autoScrollToBottom(e){try{const t=150;e.scrollHeight-e.clientHeight-e.scrollTop<t&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})}catch(t){e.scrollTop=e.scrollHeight}}updateComposerPadding(){const e=document.querySelector(".composer"),t=document.querySelector(".messages-container");if(!e||!t)return;const n=e.getBoundingClientRect().height;document.documentElement.style.setProperty("--composer-height",`${n}px`),t.style.paddingBottom=`${n+24}px`}openLeadModal(e={}){const t=document.getElementById("leadModal");e.topic&&(document.getElementById("leadTopic").value=e.topic),e.message&&(document.getElementById("leadMessage").value=e.message),this.openModal(t)}openModal(e){e.classList.add("active"),document.body.style.overflow="hidden","leadModal"===e.id&&setTimeout(()=>{const t=e.querySelector("input");t&&t.focus()},100)}closeModal(e){e.classList.remove("active"),document.body.style.overflow="","leadModal"===e.id&&document.getElementById("leadForm").reset()}async handleLeadSubmit(e){e.preventDefault();const t=new FormData(e.target),n={name:t.get("name")||void 0,email:t.get("email"),topic:t.get("topic")||void 0,message:t.get("message")||void 0};try{const e=await fetch("/api/lead",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok)throw new Error(`HTTP ${e.status}`);this.closeModal(document.getElementById("leadModal")),this.addMessage("assistant","Teşekkürler! Mesajınız başarıyla gönderildi. En kısa sürede size dönüş yapacağım.")}catch(e){console.error("Lead submission error:",e),alert("Mesaj gönderilirken bir hata oluştu. Lütfen tekrar deneyin.")}}showError(e){this.addMessage("assistant",`Hata: ${e}`,{isError:!0})}updateWelcomeTime(){const e=document.getElementById("welcomeTime");e&&(e.textContent=this.formatTime(new Date))}formatTime(e){return e.toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"})}showTypingPlaceholder(){const e=this.addMessage("assistant",'<span class="typing-dots"><span></span><span></span><span></span></span> Yazıyor...',{raw:!0});return e&&e.classList.add("typing"),e}removeTypingPlaceholder(e){try{e&&e.parentNode&&e.parentNode.removeChild(e)}catch(e){console.error("Failed to remove typing placeholder",e)}}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}function autoResizeTextarea(){const e=document.getElementById("messageInput");e.style.height="auto",e.style.height=Math.min(e.scrollHeight,120)+"px"}function initializeServiceCards(){const e=document.querySelectorAll(".service-button"),t=document.querySelectorAll(".service-modal"),n=document.querySelectorAll(".service-modal-close");let o,s,a=!1;const i=document.querySelector(".services-scroll");function d(e){const t=document.querySelector(".scroll-progress-bar"),n=e.scrollWidth-e.clientWidth,o=e.scrollLeft/n*100;t.style.width=`${o}%`}function r(){t.forEach(e=>e.classList.remove("active"))}i.addEventListener("mousedown",e=>{a=!0,i.style.cursor="grabbing",o=e.pageX-i.offsetLeft,s=i.scrollLeft}),i.addEventListener("mouseleave",()=>{a=!1,i.style.cursor="grab"}),i.addEventListener("mouseup",()=>{a=!1,i.style.cursor="grab"}),i.addEventListener("mousemove",e=>{if(!a)return;e.preventDefault();const t=2*(e.pageX-i.offsetLeft-o);i.scrollLeft=s-t,d(i)}),i.addEventListener("scroll",()=>{d(i)}),e.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.closest(".service-card").querySelector(".service-title").textContent,n=document.getElementById("messageInput"),o=document.getElementById("sendButton");n.value=`${t} hizmetiniz hakkında bilgi almak istiyorum.`,n.focus(),""!==n.value.trim()&&(o.disabled=!1)})}),n.forEach(e=>{e.addEventListener("click",r)}),t.forEach(e=>{e.addEventListener("click",function(e){e.target===this&&r()})}),document.addEventListener("keydown",function(e){"Escape"===e.key&&r()})}function initializeCommandsScroll(){const e=document.querySelector(".commands-scroll");let t,n,o=!1;e.addEventListener("mousedown",s=>{o=!0,e.style.cursor="grabbing",t=s.pageX-e.offsetLeft,n=e.scrollLeft}),e.addEventListener("mouseleave",()=>{o=!1,e.style.cursor="grab"}),e.addEventListener("mouseup",()=>{o=!1,e.style.cursor="grab"}),e.addEventListener("mousemove",s=>{if(!o)return;s.preventDefault();const a=2*(s.pageX-e.offsetLeft-t);e.scrollLeft=n-a})}document.addEventListener("DOMContentLoaded",function(){initializeServiceCards(),new InteractivePortfolio,initializeCommandsScroll();document.getElementById("messageInput").addEventListener("input",autoResizeTextarea)}),window.addEventListener("online",()=>{console.log("Connection restored")}),window.addEventListener("offline",()=>{console.log("Connection lost")});